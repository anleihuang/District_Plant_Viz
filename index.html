<!DOCTYPE html>
<meta charset="utf-8">
<title> CENTRAL PLANT WEBPAGE</title>


<!-- load css -->
<link rel="stylesheet" href="./lib/css/bootstrap.min.css" type="text/css"</link>
<link rel="stylesheet" href="./lib/css/style.css" type="text/css"</link>
<link rel="stylesheet" href="./lib/css/pure-min.css" type="text/css"</link>



<!-- load javascript libraries -->
<script src="./lib/jquery-2.2.4.min.js"></script>
<script src="./lib/d3.v3.min.js"></script>
<script type="text/javascript" charset="utf8" src="./lib/js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" charset="utf8" src="./lib/js/highstock.js"></script>
<script type="text/javascript" charset="utf8" src="./lib/js/exporting.js"></script>

<style>
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

body {
    padding-top: 0px;
    padding-right: 80px;
    padding-bottom: 0px;
    padding-left: 80px;
} 

footer {
      background-color: #e2f7ff;
	  position: absolute;
      bottom: 10;
      height: 20px;
	  width: 90%;
	  margin-top: 15px;
	  margin-bottom: 20px;
}

.topnav {
  background-color: #ececec;
  overflow: hidden;
}

input[type=button] {
    width: 100%;
    background-color: #60d3e5;
    color: white;
    padding: 14px 20px;
    margin: 8px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

input[type=number],select{
	width: 100%;
	padding:10px 20px;
	margin: 5px 0;
	display: inline-block;
	border: 1px solid #ccc;
	border-radius: 4px;
	box-sizing: border-box;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

/* runmodel */
#runmodel {
	width: 100%;
	height: auto;
	padding: 12px 20px;
	background: #f2f2f2;
	border-radius: 4px;
	/*color: white;*/
	text-align: left;
	overflow: auto;	
}

/* result format*/
#result {
	width: auto;
	height: auto;
	border-collapse: collapse;
	/*color: white;*/
	text-align: center;	
	padding: 12px 20px;
}

#result td, #result th {
    border: 1px solid black;
    padding: 8px;
}

#result tr:nth-child(even){
	background-color: #dddddd;
}

#result th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: center;
    background-color: #b2b2b2;
    color: white;
}


</style>


<body>
  
<!-- header -->
<header>
	<nav class="navbar navbar-default navbar-static-top">
          <div class="container-fluid">
            <div class="navbar-header">
              <h1> Web-based Master Planning Load Profile Generator </h1>      
          </div>
        </div>
   </nav>
</header>   
<!-- end of header -->


<div class="container-fluid">    
<!-- Summary -->  
<p class="survey"> This web-based tool aims to help the design team determine the central plant options based on the campus load profiles.
</p>

 
<div class="row"> 
	<form id="runmodel" action="/action_page.php">
		<div class="col-lg-4"> 
		<p><b>Building Total Square Footage (GSF): </b></p>
		Residential Building/ Dorm(GSF): <input type="number" name="bldg_gsf_res" value= 1527000>
		<br>
		Office Building(GSF): <input type="number" name="bldg_gsf_office" value= 1750000>
		<br>
		Community Center Building(GSF): <input type="number" name="bldg_gsf_community" value= 40000>
		<br>
		Retail Building(GSF): <input type="number" name="bldg_gsf_retail" value= 90000>
		<br>
		Grocery Store Building(GSF): <input type="number" name="bldg_gsf_grocery" value= 35000>
		<br>
		Hotel Building(GSF): <input type="number" name="bldg_gsf_hotel" value= 112500>
		<br>
		CA Climate Zone: <select name="climate_zone">
			<option>Under Development </option>
			<option>CZ 01</option>
			<option>CZ 02</option>
			<option>CZ 03</option>
			<option>CZ 04</option>
		</select>
		</div>	 
		<div class="col-lg-4"> 
		<p><b>System Efficiency: </b><p>
		Water-to-Water HP Heating Rated COP: <input type="number" name="wwhp_heating_rated_COP" value= 4.5>
		<br>
		Water-to-Water HP Cooling Rated COP: <input type="number" name="wwhp_cooling_rated_COP" value= 3.8>
		<br>
		Water Cooling Chiller Rated COP: <input type="number" name="water_cooling_chiller_rated_COP" value= 6.1>
		<br> 
		Boiler Efficiency (0~1): <input type="number" name="boiler_efficiency" value= 0.80>
		<br>
		Domestic Hot Water Efficiency (0~1): <input type="number" name="dhw_efficiency" value= 0.80>
		<br>
		<br>
		</div>	 
		<div class="col-lg-4"> 
		<p><b>Energy Efficiency Measures: </b></p>
		HVAC System Type: <select name="hvac_type">
			<option>Under Development </option>
			<option>No cooling/ Gas Heating </option>
			<option>Roof Top Unit (DX Cooling/ Gas Heating) </option>
			<option>Roof Top Unit (DX Cooling/ Electric Heating)</option>
			<option>Single Zone Split Heat Pump</option>
		</select>
		<br>
		DHW Type: <select name="dhw_type">
			<option>Under Development </option>
			<option>60% Central Water Heater </option>
			<option>Heat Exchanger</option>
			<option>Heat Pump Water Heater</option>
			<option>Electric Water Heater</option>
		</select>
		<br>		
		Energy Efficiency Measure: <select name="bldg_eems">
			<option>Under Development </option>
			<option>20% Lighting Power Density Reduction</option>
			<option>20% Plug Load Power Density Reduction</option>
			<option>Wall Upgrade</option>
			<option>Window Upgrade</option>
		</select>		
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<input type="button" onclick="runsimulation()" value = "RUN SIMULATION">
		<input type="button" onclick="window.location.reload()" value = "RESET">
		</div>	
	</form>
</div>



<!-- Show Graph-->
<div class="row">
	<div id="container"></div>
		<div id = "load_profile_graph"></div>

</div>

<div class="row"></div>
<div class="row"></div>

<div class="row"> 
	<h3> Load Summary </h3>
		<div id="result">
		<div id="result_load_summary">
	</div>
	</div>
</div>

<div class="row"> 
	<h3> Energy Summary </h3>
	<div id="result">
		<div id="result_energy_summary">
		</div>
	</div>
</div>

<script>

// Run Simulation Button Function
function runsimulation(){
	//document.getElementByID("runmodel").submit();
	var inputs = document.getElementById("runmodel");
	var out = document.getElementById("output");
	// To define user inputs
	var bldg_gsf_res= inputs.bldg_gsf_res.value;
	var bldg_gsf_office= inputs.bldg_gsf_office.value;
	var bldg_gsf_community= inputs.bldg_gsf_community.value;
	var bldg_gsf_retail= inputs.bldg_gsf_retail.value;	
	var bldg_gsf_grocery= inputs.bldg_gsf_grocery.value;	
	var bldg_gsf_hotel= inputs.bldg_gsf_hotel.value;
	var wwhp_heating_rated_COP = inputs.wwhp_heating_rated_COP.value;
	var wwhp_cooling_rated_COP = inputs.wwhp_cooling_rated_COP.value;
	var water_cooling_chiller_rated_COP = inputs.water_cooling_chiller_rated_COP.value;
	var boiler_efficiency = inputs.boiler_efficiency.value;
	var dhw_efficiency = inputs. dhw_efficiency.value;
	var totalarea = Number(inputs.bldg_gsf_office.value) + Number(inputs.bldg_gsf_community.value) + 
					Number(inputs.bldg_gsf_retail.value) + Number(inputs.bldg_gsf_grocery.value) + Number(inputs.bldg_gsf_res.value) + 
					Number(inputs.bldg_gsf_hotel.value);
	// To disply:
		// Total Cooling Primary (kbtu)	
		// Total cooling Secondary	(kbtu) = Res + Hotel
		// Total Cooling (kbtu)
		// Total Heating (kbtu)
		// Total DHW (kbtu)

	// for small
	//var parseDate = d3.time.format("%m/%d/%Y %H:%M:%S%p").parse;
	
	// for large
	var parseDate = d3.time.format("%m/%d/%Y %H:%M").parse;
	var parseDay = d3.time.format("%m/%d/%Y").parse;
	var formatDate = d3.time.format("%m/%d/%Y");
	
	d3.csv("./data/data_source.csv", function(data){
		//console.log(data);
		data.forEach(function(d){
			console.log(d["Time"])
			d.time = parseDate(d["Time"])
			console.log(d.time)
			d.date = formatDate(d.time)
			console.log(d.date)
			//Total Cooling Load
			d.Total_Cooling_multiplied_area = 
						(+d.Office_Cooling*bldg_gsf_office) +
						(+d.community_center_Cooling*bldg_gsf_community) +
						(+d.Retail_Cooling*bldg_gsf_retail) +
						(+d.Grocery_Cooling*bldg_gsf_grocery)+
						(+d.Residential_Cooling*bldg_gsf_res)+
						(+d.Hotel_Cooling*bldg_gsf_hotel)
						
			// Total DHW Load
			d.Total_DHW_multiplied_area = 
						(+d.Residential_DHW*bldg_gsf_res) +
						(+d.Office_DHW*bldg_gsf_office) +
						(+d.community_center_DHW*bldg_gsf_community) +
						(+d.Retail_DHW*bldg_gsf_retail) +
						(+d.Grocery_DHW*bldg_gsf_grocery) +
						(+d.Hotel_DHW*bldg_gsf_hotel)						
			//console.log(d.Total_DHW_multiplied_area)
			
			//Total Heating Load (no DHW load)
			d.Total_Heating_multiplied_area_noDHW = 
						(+d.Residential_Heating*bldg_gsf_res) +
						(+d.Office_Heating*bldg_gsf_office) +
						(+d.community_center_Heating*bldg_gsf_community) +
						(+d.Retail_Heating*bldg_gsf_retail) +
						(+d.Grocery_Heating*bldg_gsf_grocery) +
						(+d.Hotel_Heating*bldg_gsf_hotel)

			//console.log(d.Total_Heating_multiplied_area_noDHW)
						
		
			//Total Heating Load (including DHW load)
			d.Total_Heating_multiplied_area = d.Total_Heating_multiplied_area_noDHW + d.Total_DHW_multiplied_area
			
			//console.log(d.Total_Heating_multiplied_area)

			
			// ============================================
			// Simultaneous heating/cooling load calculation
			// ============================================
			
			// Available Simultaneous cooling load (kbtu)	
			// Available Simultaneous heating load = =IF(Total_Cooling *1.4< Total_Heating,Total_Cooling,Total_Heating/1.4)
			if (d.Total_Cooling_multiplied_area < d.Total_Heating_multiplied_area){
				d.Available_Simultaneous_cooling_load = d.Total_Cooling_multiplied_area;
				}
			else{
				d.Available_Simultaneous_cooling_load = d.Total_Heating_multiplied_area;		
				}
			//console.log(d.Available_Simultaneous_cooling_load)	
				
			// Available Simultaneous heating load (kbtu)	
				d.Available_Simultaneous_heating_load = d.Available_Simultaneous_cooling_load		
			//console.log(d.Available_Simultaneous_heating_load)
		
			// Available Simultaneous DHW load
			if (d.Available_Simultaneous_heating_load < d.Total_Heating_multiplied_area_noDHW){
				d.Available_Simultaneous_dhw_load = d.Available_Simultaneous_heating_load - d.Available_Simultaneous_heating_load;
				}
			else{
				d.Available_Simultaneous_dhw_load = d.Available_Simultaneous_heating_load - d.Total_Heating_multiplied_area_noDHW;		
				}
			//console.log(d.Available_Simultaneous_dhw_load)
			
			// =============================
			// WWHP energy
			// ============================
			
			// Water to water heat pump heating energy = Free heating/ WWHP heating rated COP

				d.wwhp_heating_energy = d.Available_Simultaneous_heating_load/ wwhp_heating_rated_COP;
				
			// Water to water heat pump cooling energy = =IF(Actual Simultaneous DHW load=0,Free Cooling/WWHP cooling rated COP,0)

				if(d.Actual_Simultaneous_DHW_load = 0){
					d.wwhp_cooling_energy = d.Available_Simultaneous_cooling_load/ wwhp_cooling_rated_COP;
				}
				else{						
					d.wwhp_cooling_energy = 0;
				}
			//console.log(d.wwhp_cooling_energy)
			
			// Chiller Energy = =(Total Cooling Load - Free cooling load)/ Water cooling chiller rated COP
				d.chiller_energy = (d.Total_Cooling_multiplied_area - d.Available_Simultaneous_cooling_load) / water_cooling_chiller_rated_COP;
		
			// Boiler Energy = =(Total_Heating_multiplied_area_val - Free Heating)/boiler_efficiency
				d.boiler_energy = (d.Total_Heating_multiplied_area - d.Available_Simultaneous_heating_load) / boiler_efficiency;



		  // DHW Energy = =(Total DHW - Actual Simultaneous DHW load - Solar thermal load for residential)/dhw_efficiency
		  // TODOS: To include "Solar thermal load for residential"
				d.dhw_energy = (d.Actual_Simultaneous_DHW_load - d.Available_Simultaneous_dhw_load) / dhw_efficiency;
			});
		  
		//console.log(data)

		var Total_Cooling_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +(d.Total_Cooling_multiplied_area); }); })
				  .entries(data);		

		var Total_Heating_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +(d.Total_Heating_multiplied_area_noDHW); }); })
				  .entries(data);	

		var Total_dhw_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +(d.Total_DHW_multiplied_area); }); })
				  .entries(data);	
		
		var Total_simul_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +(d.Available_Simultaneous_cooling_load); }); })
				  .entries(data);	
				  
		var Max_Cooling_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.max(v, function(d) { return +(d.Total_Cooling_multiplied_area); }); })
				  .entries(data);		

		var Max_Heating_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.max(v, function(d) { return +(d.Total_Heating_multiplied_area_noDHW); }); })
				  .entries(data);	

		var Max_dhw_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.max(v, function(d) { return +(d.Total_DHW_multiplied_area); }); })
				  .entries(data);	

		var Max_simul_load_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.max(v, function(d) { return +(d.Available_Simultaneous_cooling_load); }); })
				  .entries(data);	

				
		var Total_Cooling_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +(d.wwhp_cooling_energy + d.chiller_energy); }); })
				  .entries(data);
		//console.log(Total_Cooling_year_nest)
		
		var Total_Heating_Elect_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +d.wwhp_heating_energy; }); })
				  .entries(data);
		//console.log(Total_Heating_Elect_year_nest)
		
		var Total_Heating_Gas_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +d.boiler_energy; }); })
				  .entries(data);
		//console.log(Total_Heating_Gas_year_nest)
		
		var Total_DHW_year_nest = d3.nest()
				  .key(function(d) { return (d3.time.year(d.time)); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +d.dhw_energy; }); })
				  .entries(data);

		
		var Total_Cooling_day_nest = d3.nest()
				  .key(function(d) { return (d.date); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return +d.Total_Cooling_multiplied_area; }); })
				  .entries(data);
				  
			Total_Cooling_day_nest.forEach(function(d) {
					d.key = (parseDay(d.key));
					})
					
		//console.log(Total_Cooling_day_nest)
		//console.log(JSON.stringify(Total_Cooling_day_nest))	
		
		var Total_DHW_day_nest = d3.nest()
				  .key(function(d) { return (d.date); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return d.Total_DHW_multiplied_area; }); })
				  .entries(data);
			
			Total_DHW_day_nest.forEach(function(d) {
					d.key = (parseDay(d.key));
					})


		var Total_Heating_day_nest = d3.nest()
				  .key(function(d) { return (d.date); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return d.Total_Heating_multiplied_area; }); })
				  .entries(data);
			//console.log(JSON.stringify(Total_Heating_day).values)
			Total_Heating_day_nest.forEach(function(d) {
					d.key = (parseDay(d.key));
					})
				  
		var Total_Free_Cooling_day_nest = d3.nest()
				  .key(function(d) { return (d.date); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return d.Available_Simultaneous_cooling_load; }); })
				  .entries(data);
			Total_Free_Cooling_day_nest.forEach(function(d) {
					d.key = (parseDay(d.key));
					})
				  
		var Total_Free_Heating_day_nest = d3.nest()
				  .key(function(d) { return (d.date); })
				  .rollup(function(v) { return d3.sum(v, function(d) { return d.Available_Simultaneous_heating_load; }); })
				  .entries(data);
			Total_Free_Heating_day_nest.forEach(function(d) {
					d.key = (parseDay(d.key));
					})
				  
		 //Show / hide elements on mouse click with d3.js : http://bl.ocks.org/d3noob/5d621a60e2d1d02086bf
		var margin = {top: 20, right: 200, bottom: 100, left: 80},
			margin_context = {top: 500, right: 200, bottom: 20, left: 80},
			width = 1500 - margin.left - margin.right,
			height_focus = 600 - margin.top - margin.bottom,
			height_context = 600 - margin_context.top - margin_context.bottom;
			
			
		var svg = d3.select("#load_profile_graph").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height_focus + margin.top + margin.bottom);

		
			svg.append("defs")
				.append("clipPath")
				.attr("id", "clip")
				.append("rect")
				.attr("width", width)
				.attr("height", height_focus);

		var focus = svg.append("g")
			.attr("class", "focus")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var context = svg.append("g")
			.attr("class", "context")
			.attr("transform", "translate(" + margin_context.left + "," + margin_context.top + ")");

		var x_focus = d3.time.scale().range([0, width]),
			x_context = d3.time.scale().range([0, width]),
			y_focus = d3.scale.linear().range([height_focus, 0]),
			y_context = d3.scale.linear().range([height_context, 0]);


		var xAxis = d3.svg.axis().scale(x_focus).orient("bottom"),
			xAxis2 = d3.svg.axis().scale(x_context).orient("bottom"),
			yAxis = d3.svg.axis().scale(y_focus).orient("left");


		var brush = d3.svg.brush()
			.x(x_context)
			.on("brush", brushed);
	

		  x_focus.domain(d3.extent(data, function (d) {
					return parseDay(d.date);
				  }));
		y_focus.domain([-Max_Cooling_load_year_nest[0].values*12, Max_Cooling_load_year_nest[0].values*15]);
		x_context.domain(x_focus.domain());
		y_context.domain(y_focus.domain());			

		//need to update
		//var contextLine = d3.svg.line()
		var contextLine = d3.svg.area()
			.x(function(d) { return x_context(d.key); })
			//.y(function(d) { return y_context(d.Total_Cooling_multiplied_area-d.Total_Heating_multiplied_area); })
			.y(function(d) { return y_context(+d.values); })
			.y0(function(d) { return y_context(-d.values); })
			//.y(function(d) { d3.values(d).map(function(v) { 
			.interpolate("linear");
			
		var Total_Cooling_Area = d3.svg.area()
			.x(function(d) { return x_focus((d.key)); })
			//.y(function(d) { return y_focus(d.Total_Cooling_multiplied_area); })
			.y(function(d) { return y_focus(+d.values); })
			.y0(function(d) {return y_focus(0);})
			.interpolate("linear");

		var Total_Heating_Area = d3.svg.area()
			//.x(function(d) { return x_focus(d.time); })
			.x(function(d) { return x_focus((d.key)); })			
			//.y(function(d) { return y_focus(-d.Total_Heating_multiplied_area); })
			.y(function(d) { return y_focus(-d.values); })
			.y0(function(d) {return y_focus(0);})
			.interpolate("linear");

		var Total_DHW_Area = d3.svg.area()
			//.x(function(d) { return x_focus(d.time); })
			.x(function(d) { return x_focus((d.key)); })	
			//.y(function(d) { return y_focus(-d.Total_DHW_multiplied_area); })
			.y(function(d) { return y_focus(-d.values); })
			.y0(function(d) {return y_focus(0);})
			.interpolate("linear");			

		var Simul_Heating = d3.svg.area()
			//.x(function(d) { return x_focus(d.time); })
			.x(function(d) { return x_focus((d.key)); })	
			//.y(function(d) { return y_focus(-d.Available_Simultaneous_heating_load); })
			.y(function(d) { return y_focus(-d.values); })
			.y0(function(d) {return y_focus(0);})
			.interpolate("linear");		

		var Simul_Cooling = d3.svg.area()
			//.x(function(d) { return x_focus(d.time); })
			.x(function(d) { return x_focus((d.key)); })	
			//.y(function(d) { return y_focus(d.Available_Simultaneous_cooling_load); })
			.y(function(d) { return y_focus(+d.values); })
			.y0(function(d) {return y_focus(0);})
			.interpolate("linear");					

		focus.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height_focus + ")")
		  .call(xAxis);

		focus.append("g")
		  .attr("class", "y axis")
		  .call(yAxis);

		focus.append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 0 - margin.left)
		  .attr("x",0 - (height_focus / 2))
		  .attr("dy", "1em")
		  .style("text-anchor", "middle")
		  .text("Load (btu)");  
		  
		context.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height_context + ")")
		  .call(xAxis2);

		focus.append("path")
		  //.datum(data)
		  .datum(Total_Cooling_day_nest)
		  .style("fill","steelblue")
		  .style("fill-opacity",0.9)
		  .attr("id","cooling_load")
		  .attr("clip-path", "url(#clip)")
		  .attr("d", Total_Cooling_Area);

		  
		focus.append("path")
		  //.datum(data)
		  .datum(Total_Heating_day_nest)
		  .style("fill","red")
		 .style("fill-opacity",0.6)
		  .attr("id","heating_load")
		  .attr("clip-path", "url(#clip)")
		  .attr("d", Total_Heating_Area);


		  focus.append("path")
		  //.datum(data)
		  .datum(Total_DHW_day_nest)
		  .style("fill","orange")
		 .style("fill-opacity",0.6)
		  .attr("id","dhw_load")
		  .attr("clip-path", "url(#clip)")
		  .attr("d", Total_DHW_Area);

		focus.append("path")
		  //.datum(data)
		  .datum(Total_Free_Heating_day_nest)
		  .style("fill","green")
		  .style("fill-opacity",0.6)
		  .attr("id","simul_heating_load")
		  .attr("clip-path", "url(#clip)")
		  .attr("d", Simul_Heating);
		  
		  focus.append("path")
		  //.datum(data)
		  .datum(Total_Free_Cooling_day_nest)
		  .style("fill","green")
		  .style("fill-opacity",0.6)
		  .attr("id","simul_cooling_load")
		  .attr("clip-path", "url(#clip)")
		  .attr("d", Simul_Cooling);		  

		  
		context.append("path")
			  .datum(Total_Free_Cooling_day_nest)
				.style("fill","green")
				.style("fill-opacity",0.6)
			  //.attr("class", "line")
			  .attr("clip-path", "url(#clip)")
			  .attr("d", contextLine);	  
			  
			context.append("g")
			  .attr("class", "x brush")
			  .call(brush)
			  .selectAll("rect")
			  .attr("y", -6)
			  .attr("height", height_context + 7);
		  
		function brushed() {
		  x_focus.domain(brush.empty() ? x_context.domain() : brush.extent());
		  focus.select("#cooling_load").attr("d", Total_Cooling_Area);
		  focus.select("#heating_load").attr("d", Total_Heating_Area);
		  focus.select("#dhw_load").attr("d", Total_DHW_Area);
		  focus.select("#simul_heating_load").attr("d", Simul_Heating);
		  focus.select("#simul_cooling_load").attr("d", Simul_Cooling);
		  focus.select(".x.axis").call(xAxis);
		};

		legend = focus.append("g")
		  .attr("class","legend")
		  .attr("transform","translate(50,50)")  
		  .style("font-size","14px")
		 
		legend.append('text')
			.text("Total Cooling Load (btu)")
			.style("stroke", "blue")
			.on("click", function(){
				// Determine if current line is visible
				var active   = cooling_load.active ? false : true,
				  newOpacity = active ? 0 : 1;
				// Hide or show the elements
				d3.select("#cooling_load").style("opacity", newOpacity);
				// Update whether or not the elements are active
				cooling_load.active = active;
			})
				  
		legend.append('text')
			.text("Total Heating Load (btu)")
			.style("stroke", "red")
			.attr("y", 20)
			.on("click", function(){
				var active   = heating_load.active ? false : true,
				  newOpacity = active ? 0 : 1;
				d3.select("#heating_load").style("opacity", newOpacity);
				heating_load.active = active;
			})

		legend.append('text')
			.text("Total DHW Load (btu)")
			.style("stroke", "orange")
			.attr("y", 40)
			.on("click", function(){
				var active   = dhw_load.active ? false : true,
				  newOpacity = active ? 0 : 1;
				d3.select("#dhw_load").style("opacity", newOpacity);
				dhw_load.active = active;
			})
			
		legend.append('text')
			.text("Simultaneous Cooling/ Heating (btu)")
			.style("stroke", "green")
			.attr("y", 60)
			.on("click", function(){
				var active   = simul_heating_load.active ? false : true,
					newOpacity = active ? 0 : 1;
				d3.select("#simul_heating_load").style("opacity", newOpacity);
				d3.select("#simul_cooling_load").style("opacity", newOpacity);
				simul_heating_load.active = active;
			})
			
			var format_no_decimal = d3.format(",.0f")
			var format = d3.format(",.2f")
			
			//Load Summary
			$('#result_load_summary').append('<tr><td></td><td >Campus Cooling</td><td>Campus Heating</td><td>Campus DHW</td></tr>');
			$('#result_load_summary').append('<tr><td> Annual Total </td><td>' + format_no_decimal(Total_Cooling_load_year_nest[0].values/1000) + ' mmbtu/yr</td><td>' + format_no_decimal(Total_Heating_load_year_nest[0].values/1000) + ' mmbtu/yr</td><td>' + format_no_decimal(Total_dhw_load_year_nest[0].values/1000) + ' mmbtu/yr</td></tr>');
			$('#result_load_summary').append('<tr><td> Peak </td><td>' + format_no_decimal(Max_Cooling_load_year_nest[0].values) + ' btu/hr</td><td>' + format_no_decimal(Max_Heating_load_year_nest[0].values) + ' btu/hr</td><td>' + format_no_decimal(Max_dhw_load_year_nest[0].values) + ' btu/hr</td></tr>');
			$('#result_load_summary').append('<tr><td>Heat Recovery Opportunities</td><td colspan = "3"> ' + ((Total_simul_load_year_nest[0].values/(Total_Heating_load_year_nest[0].values+Total_dhw_load_year_nest[0].values))*100).toFixed(2) + ' % of Total heating Load can be covered by waster heat</td></tr>');
			
			baseline_cooling_elec = (Total_Cooling_load_year_nest[0].values/5/1000)
			baseline_heating_gas = ((Total_Heating_load_year_nest[0].values+ Total_dhw_load_year_nest[0].values)/0.8/1000)
			baseline_total = baseline_cooling_elec + baseline_heating_gas
			proposed_cooling_elec = (Total_Cooling_year_nest[0].values/1000)
			proposed_heating_elec = (Total_Heating_Elect_year_nest[0].values/1000)
			proposed_heating_gas = (Total_Heating_Gas_year_nest[0].values/1000)
			proposed_total = proposed_cooling_elec + proposed_heating_elec + proposed_heating_gas
			
			// Energy Summary
			$('#result_energy_summary').append('<tr><td></td><td colspan = "2"> Baseline </td><td colspan = "2"> Proposed </td></tr>');
			$('#result_energy_summary').append('<tr><td>Total Campus Area </td><td colspan = "4">' + format_no_decimal(totalarea) +  ' sq.ft. </td></tr>');
			$('#result_energy_summary').append('<tr><td>Cooling System</td><td colspan = "2"> 5 COP Water-cooled Chillers  </td><td colspan = "2"> Heat Recovery Chiller </td></tr>');
			$('#result_energy_summary').append('<tr><td>Heating System</td><td colspan = "2"> 80% Boiler </td><td colspan = "2"> Boiler </td></tr>');
			$('#result_energy_summary').append('<tr><td>DHW System</td><td colspan = "2"> 80% Boiler </td><td colspan = "2"> Boiler </td></tr>');		
			$('#result_energy_summary').append('<tr><td> Total cooling energy </td><td>' + format(baseline_cooling_elec) + '  mmbtu</td><td>' + format(baseline_cooling_elec*1000/totalarea) + ' kBtu/sf-yr</td><td>' + format(proposed_cooling_elec) + '  mmbtu</td><td>' + format(proposed_cooling_elec*1000/totalarea) + ' kBtu/sf-yr</td></tr>');
			$('#result_energy_summary').append('<tr><td> Total Heating electricity energy </td><td>' + 0 + '  mmbtu</td><td>' + 0 + ' kBtu/sf-yr</td><td>' + format(proposed_heating_elec) + '  mmbtu</td><td>' + format(proposed_heating_elec*1000/totalarea) + ' kBtu/sf-yr</td></tr>');
			$('#result_energy_summary').append('<tr><td> Total heating Gas Energy </td><td>' + format(baseline_heating_gas) + '  mmbtu</td><td>' + format(baseline_heating_gas*1000/totalarea)+ ' kBtu/sf-yr</td><td>'+ format(proposed_heating_gas) + '  mmbtu</td><td>' + format(proposed_heating_gas*1000/totalarea) +' kBtu/sf-yr</td></tr>');
			//$('#result_energy_summary').append('<tr><td> Total pump Energy </td><td>' + result + ' mmbtu</td><td>' + result + ' kBtu/sf-yr</td></tr>');
			//$('#result_energy_summary').append('<tr><td> Total pump Energy </td><td>' + result + ' mmbtu</td><td>' + result + ' kBtu/sf-yr</td></tr>');
			//$('#result_energy_summary').append('<tr><td> Total pump Energy </td><td>' + result + ' mmbtu</td><td>' + result + ' kBtu/sf-yr</td></tr>');
			$('#result_energy_summary').append('<tr><td> Total Cooling & Heating Energy Intensity </td><td>' + format(baseline_total)  + ' mmbtu</td><td>' + format(baseline_total*1000/totalarea)  + ' kBtu/sf-yr</td><td>' + format(proposed_total)  + ' mmbtu</td><td>' + format(proposed_total*1000/totalarea)  + ' kBtu/sf-yr</td></tr>');
	}
	);
}


		
// Add output table
// Fixed the y-axis
//Download calculated data
		
</script>


<!-- footer -->
<footer class="footer">
      <div class="container-fluid">
        <p>If you have any questions, please feel free to contact Te Qi (gtqite@gmail.com) and An-Lei Huang (anery817@gmail.com) </p>
      </div>
</footer>
<!-- end of footer -->

</div> 
</body>
</html>

<!-- 
REFERNCE:
http://cs.au.dk/~mis/JS/sli05.html

Reload
https://medium.com/code-kings/datatables-js-how-to-update-your-data-object-for-ajax-json-data-retrieval-c1ac832d7aa5

Convert:
http://datatables.club/upgrade/1.10-convert.html

Create PDF
http://108.160.144.86/pexpenses.php?PID=1

Range Selector
https://bl.ocks.org/mbostock/34f08d5e11952a80609169b7917d4172
-->
